---
title: "12. 调整大小"
date: 2021-06-14T12:18:42+10:00
draft: false
weight: 120
---

由于各种原因，过度配置是现实生活中 SDDC 中常见的不当做法。 P2V 是一个常见原因，因为 VM 刚好与物理服务器的大小相匹配。另一个原因是供应商的规模调整保守，然后由应用团队进一步添加。

我见过大型企业客户试图进行大规模调整，以减少许多虚拟机的大小，但当虚拟机性能受到影响时却适得其反。

由于性能至关重要，您应该从这个角度解决它。尽管逻辑看起来很奇怪，但要让 VM 所有者知道正确调整大小实际上可以提高性能需要花费大量时间和精力。胡萝卜比大棒更有效，尤其是对有钱人。在大多数情况下，节省资金是一个弱论点，因为 VM 所有者已经为 VM 付费了。

![超大机器的缺点](1.3.12-fig-1.png)

调整大小对于 VM 很重要，比对物理服务器更重要。以下是一些好处：

- 来宾操作系统内的进程可能会遇到较少的乒乓问题。 Guest OS 可能不知道物理主板的 [NUMA](https://en.wikipedia.org/wiki/Non-uniform_memory_access) 性质，并认为它具有统一的结构。它可以在自己的 CPU 内移动进程，因为它假定它没有性能影响。如果将 vCPU 分散到不同的 NUMA 节点，例如在具有 2 插槽和 20 核的盒子上安装 20 个 vCPU，则可以体验乒乓效应。
- 降低 NUMA 效应的风险。降低 RAM 或 CPU 分布在单个插槽上的风险。由于 NUMA 架构，性能不会那么好。
- 降低共同停车和准备时间。即使应用程序并未使用所有 vCPU，Guest OS 仍会要求管理程序提供所有 vCPU。
- 更快的快照时间，尤其是在包含内存快照的情况下。
- 更快的启动时间。如果 VM 没有预留空间，vSphere 将创建一个与配置的 RAM 大小相同的交换文件。如果存储子系统很慢，这会影响启动时间。
- 更快的 vMotion。 Windows 和 Linux 使用内存作为缓存。它拥有的越多，使用的就越多，其他条件都一样。

## 过度配置的严重程度

如果您有数千个大型虚拟机，您如何轻松地向高级管理层传达许多大型虚拟机没有使用过去几个月提供给他们的 CPU 的信息？

您需要展示一个令人信服的图表，该图表显示每 5 分钟数百个大型 VM（您定义为具有 > 16 个 vCPU）的利用率，因此您的演示文稿中不排除一个短峰值。

您需要做的第一件事是创建一个动态组来捕获所有大型 VM。为 CPU 创建 1 组，为 RAM 创建一组。然后，您可以在过去 3 个月内每 5 分钟绘制一次它们的利用率。

在完美的世界中，如果所有大型 VM 的大小都合适，您会看到哪种情况？

![过度配置的场景](1.3.12-fig-2.png)

这是正确的。场景 2。由于该组有数百名成员，因此其中一个大型 VM 很可能正在使用为其提供的 CPU。平均而言，它们应该在 40 - 50% 左右徘徊，因为在任何给定的 5 分钟间隔内，有些人可能空闲，而另一些人可能很忙。

我们用于 CPU 和 RAM 的技术是相同的。我会以 CPU 为例。

创建组后，下一步是创建两个 [超级指标](https://blogs.vmware.com/management/2020/09/my-top-15-vrealize-operations-super-metrics.html):

#### 最大()

这些大型虚拟机之间的最大 CPU 工作负载。

您预计这个数字会徘徊在 80% 左右，因为所有大型虚拟机，只需要 1 个虚拟机就可以使折线图达到峰值。

如果您的最大线始终为 ~100% 平坦，则您的过程可能会失控。

如果您有许多大型虚拟机，那么在任何给定时间，其中一个往往会被高度利用。

如果这个数字很低，就意味着浪费严重！

#### 在最低限度()

这些大型虚拟机之间的平均 CPU 工作负载。

您希望这个数字徘徊在 40% 左右，这表明调整大小是正确的。

如果图表在整个月内保持低于 20%，则所有大型 VM 都太大。

------

为什么不需要创建最小值？

在任何给定时间都必须有一个空闲的虚拟机。

两个折线图向我们展示了过度配置的程度。你能说出一个限制吗？

它位于柜台本身。我们无法区分 CPU 使用率是否是由实际需求引起的。真正的需求来自应用。虚幻的需求来自基础设施，例如：

- 来宾操作系统重新启动。
- AV 全扫描。
- 进程失控。如果应用程序是多线程的，这可能会导致 100% 的 CPU 需求。如何区分失控的进程和合法的高工作负载是一个挑战。

## 公式的两个方面

虚拟机大小是一个经常被误解的术语，因为实际上有多个用例，每个用例都有自己需要考虑的因素。不同的场景需要不同的指标。它不是万能的，所以有不止一种公式。以下是一些流行的用例：

- 您的应用团队需要额外的 vCPU。在这种情况下，管理程序开销无关紧要。调整 NSX Edge vCPU 的大小时，您无需为开销添加额外的 vCPU。它是在 Linux 之外完成的。
- 您正在将 VM 迁移到 CPU 速度为 2 倍的新 ESXi。例如，从 2 GHz ESXi 到 4 GHz。在其他条件相同的情况下，您可以将 VM 大小减少 2。16 个 vCPU 变为 8 个。但是您担心在来宾操作系统内造成队列，因为应用程序可能需要 16 个慢线程与 8 个快速线程。
- 您正在将许多 VM 批量迁移到另一个集群，而没有更改它们的配置。考虑 2 个 VM。两者都运行 Windows Server 2019，具有 64 个 vCPU。两者都运行得很热，但其中之一的 IO 很重。它发送大量网络数据包并执行大量磁盘 IOPS。第二个虚拟机在 ESXi 上的占用空间大不相同。它的要求要高得多。所有这些 IO 处理都需要由其他物理内核处理。在这种情况下，您需要考虑外部占用空间。来宾操作系统中的队列无关紧要。
- 你的老板要求你适当地向客户收费，说明他们的实际要求。你会以同样的方式为上面的两个虚拟机充电吗？你可能出于实际原因，悄悄地平均分配成本，但你知道你不公平。
- 您正在计划对集群 X 进行技术更新。它有 24 个 ESXi 和 1000 个虚拟机。您希望将基础架构减少到 12 个 ESXi，因此您可以提高 CPU 速度并为每个插槽添加内核。您是考虑单个 VM，还是确实看到它们作为一个组的行为？答案是后者，因为 1000 VM 不会同时达到峰值。您是否考虑过 Windows 或 Linux 内部发生的情况，或者您是否看到它们在 ESXi 上的足迹？正确答案是后者，因为内部发生的事情无关紧要。

从以上 5 个用例中，我们至少需要两个不同的公式：

- 来宾操作系统大小调整。不包括 VM 开销，包括来宾操作系统队列
- 虚拟机大小调整。包括 VM 开销，不包括来宾操作系统队列

| 规则 | 描述 |
| --- | --- |
| 这不仅仅是利用率 | 它需要考虑未满足的需求。 CPU想运行，但不能。内存在客户操作系统内存中有很多页面错误。|
| 不仅仅是需求 | 大小基于来宾操作系统需要什么才能正常运行，而不仅仅是基于它当前的需求。适用于 RAM，如果没有缓冲区，Guest OS 无法以最佳方式运行。<br />在容量方面，我们不仅根据需求进行调整，而且还根据性能进行调整。虽然我们可以仅使用 In Use 来满足对内存的需求，但这可能会以牺牲性能为代价。唯一比内存更快的是CPU。因此请确保 CPU 不等待数据。这是通过尽可能多地缓存来完成的，因为很难预测程序需要哪些数据。|
| 包括峰值 | 考虑繁忙或高峰期，因为那是 VM 最需要工作的时候 |
| 考虑大局| 一次 5 分钟的突发时间太短，无法确定整个接下来的 3 个月。考虑长期模式。仅此一项就使确定尺寸成为一门艺术，因为您需要了解工作量的性质. |
| 不包括 IT 负载 | 排除来宾操作系统不执行业务工作负载的时间。有一些 IT 工作负载会导致高利用率。常见的有客户操作系统重启、客户操作系统更新、防病毒完全扫描、基于代理的完整备份。只要这些任务不会阻止来宾操作系统执行有用的工作，您就可以排除它们。例外情况是您的 VM 也需要在这些非工作时间运行。所以它取决于虚拟机。<br />这是困难的部分，因为它需要了解足迹（读取：进程名称）|

向上和向下调整大小应该有相同的公式。

- 唯一的区别是他们有不同的界限。下限适用于缩小规模，而上限适用于扩大规模。
- 为了缩小规模，Guest OS 需要最少的 RAM 才能运行。
- 对于扩大规模，请考虑 NUMA 边界。此外，VM 不应大于 ESXi 主机上的逻辑处理器总数，否则它甚至无法启动。事实上，它应该更小，因为您要考虑 VMkernel 开销。

从上面可以看出，调整大小很复杂。以上只是来宾操作系统。我们还没有考虑其他需要调整大小的东西，例如容器和业务应用程序。

调整大小的艺术有两个部分：时间和度量。

- 首先，我们计算给定时间点的值。输入值的正确性很重要，否则你有 [GIGO](https://en.wikipedia.org/wiki/Garbage_in,_garbage_out) 效果。
- 其次，我们随时间绘制数千个这些值，并随着时间的推移对其进行投影。预测必须考虑高峰周期，这意味着它必须面向保守的规模。它还必须考虑商业周期。如果您有年度销售额，请考虑年度数据。

您将在下面看到 CPU 和 RAM 需要不同的方法。

## 来宾操作系统 CPU 大小调整

您排除了所有 VM 开销，因为来宾操作系统不使用它。例如，在确定 Windows 或 Linux 应配置多少 CPU 时，不应包括管理程序执行的所有 IO 开销。对于磁盘大小调整，快照不是 VMDK 大小调整的一部分。

| 规则 | 描述 |
| --- | --- |
| 排除超线程 | 无论速度和吞吐量如何，来宾操作系统都在运行。效率较低，它只会运行更长时间。它可能会运行 90%，而不是 5 分钟的 40%。如果超过 100%，那么 Guest OS 内部会出现队列。<br />Demand 和 Usage 计数器不合适，因为它们的值受 CPU 频率和 HT 的影响|
| 排除 CPU 频率 | 如上。此处唯一的例外是初始大小调整，此时 VM 尚未创建。应用团队可能需要 32 个 vCPU，频率为 3 GHz。如果您拥有的是 2 GHz，则需要提供更多的 vCPU.|
| 排除空闲时间 | CPU 没有运行。是否因为来宾 OS CPU 正在等待来宾 OS IO 无关紧要。最终结果是来宾操作系统没有运行其 CPU。虽然使 IO 子系统更快会导致更高的 CPU 利用率，但这是一个单独的范围。|
| 排除 CPU 上下文切换 | 这是你无法控制的。此外，无法将其值转换为正确的大小公式。此外，过多的 vCPU 或 IO 可能会导致高上下文切换。来宾操作系统只是在其 vCPU 之间进行平衡。 <br />利用率可能高，但是如果CPU做大量上下文切换，效率就低.|
| 包括 Co Stop & Ready |来宾操作系统实际上想要运行。如果没有阻塞，就会使用CPU。添加/减少 CPU 不会改变这些等待的值，因为它代表了其他地方的瓶颈。但是，它确实说这是 CPU 需要的，我们需要反映这一点。 <br />Guest OS 编号会不准确，因为它的时间被冻结，因此没有“无数据”。 |
|包括 VM 等待、交换等待 |当 CPU 等待 RAM 或 IO（磁盘或网络）时，来宾操作系统变为空闲。所以这和 Ready 和 CoStop 的情况是一样的。
|包括重叠 |来宾操作系统实际上想要运行，但被 VMkernel 中断。请注意，这已经是 CPU Run 的一部分，因此如果我们使用 CPU Run 计数器，则在数学上是不必要的。 |
|包括客户操作系统 CPU 运行队列 |如果 Windows 或 Linux 不能满足需求，这是主要的计数器跟踪。 |
|排除管理程序开销| MKS、VMX、系统。虽然它是需求的一部分，但它不是来自客人内部的需求。 <br />VM CPU Used、Demand 和 Usage 计数器包括 VM 级别的系统时间，因此它们不合适。 |

基于以上所有内容，确定客户操作系统大小的公式为：

```text
来宾操作系统所需 CPU (vCPU) = (Run + CoStop + Ready + VM Wait + Swap Wait) / 20000 ) + CPU 运行队列因子
```

结果是 vCPU 的数量。它不是以 % 或 GHz 为单位的。我们正在调整客户操作系统的大小，而不是虚拟机。

我们需要除以 20,000，因为 20,000 毫秒代表单个 vCPU 的 100%。 [此处](/zh/metrics/chapter-1-overview/2.1.3-roll-up-vs-aggregation/) 解释了有关此单元的更多信息。

来宾操作系统 CPU 运行队列指标需要进行一些转换才能使用。让我们举个例子：

- VM 有 8 个 vCPU。
- 整个 VM 的 CPU 运行队列 = 28。
- VM 可以处理 8 x 3 = 24 个队列。
- 缺少 28 - 24 = 4 个队列。
- 每个额外的 vCPU 可以处理 1 个进程 + 3 个队列。
- 结论：我们添加了 1 个 vCPU。

与 CPU Usage 相比，没有 CPU 运行队列因素的 Guest OS Needed 差异趋于 10% 以内。使用率更高，因为它包括系统时间和涡轮增压。在 HT 和 CPU 频率降低的情况下，使用率会更低。

这是一个使用率较高的示例。

![高使用率示例](1.3.12-fig-3.png)

以下是使用率较低的示例：

![低使用率示例](1.3.12-fig-4.png)

一旦我们知道客户操作系统需要什么，我们就可以计算推荐的大小。这是一个预测，需要很多价值。理想情况下，建议是 [NUMA 感知](https://blogs.vmware.com/management/2019/09/26212.html)。 ***在确定尺寸后*** 应用。您调整大小，然后调整以考虑 NUMA。此调整取决于 ESXi 主机。因此，如果您的 vSphere 集群不同，它可能因集群而异。

```text
来宾操作系统推荐大小 (vCPU) = 向上取整 NUMA（投影（需要来宾操作系统 (vCPU)）
```

对于基本的 NUMA 兼容，使用 1 个插槽多核，直到超出插槽边界。这意味着您使用 2 个 vCore 1 vSocket，而不是 2 个 vSocket，每个 vSocket 有 1 个 vCore。

随着 Windows 2008 的发布，切换硬件抽象层 (HAL) 由操作系统自动处理，并且随着 64 位 Windows 的发布，单处理器和多处理器机器没有单独的 HAL 的概念。这意味着一个 vCPU 是一个有效的配置，您不应该将两个 vCPU 设为最小值。

如果集群中混合了具有不同 NUMA 节点大小的 ESXi，则应在整个集群中使用最小的 NUMA 节点大小。例如，12-vCPU VM 应该是 2 插槽 x 6 核而不是 1 插槽 x 12 核，因为这更适合双插槽 10 核和双插槽 12 核主机。请注意，主机和 VM 上的内存量可能会更改该建议，因此该建议假设内存不是您的方案中的限制因素。

请注意，该数字以 vCPU 为单位，而不是 GHz，而不是 %。原因是调整是在整个 vCPU 上完成的。事实上，在大多数情况下，它应该是偶数，因为当您跨越 CPU 插槽的大小时，奇数在 NUMA 中不起作用。

请注意，当您更改 VM 配置时，可能需要更改应用程序设置。这尤其适用于管理自身内存（例如数据库和 JVM）并安排固定数量威胁的应用程序。

您可以在 VM 上启用热添加，但请注意对 NUMA 的影响。

参考: [调整大小](https://blogs.vmware.com/management/2020/01/rightsizing-vms-with-vrealize-operations.html) by Brandon Gordon.

## 虚拟机 CPU 大小调整

需要针对迁移用例或退款用例调整 VM 大小。

|规则 |说明 |
| --- | --- |
|包括超线程|当 VM 在运行对等线程的线程上运行时，其 CPU 周期会减少。 |
|包括CPU频率| |
|包括VM开销| |
|排除来宾操作系统队列 | |
|包括VM队列| |

基于上述所有内容，确定 VM 大小的公式为：

```text
所需的 VM CPU (vCPU) = (已使用 + CoStop + 就绪 + VM 等待 + 交换等待) + 系统 / 20000 )
```

唯一需要转换为 GHz 的时候是需要迁移到另一个时钟速度不同的 ESXi 时。为了转换为 GHz，我们将数字乘以标称的静态时钟速度。您还可以通过考虑 [CPU 生成和速度](https://www.spec.org/cpu2017) 来增强这一点，尽管如果处理不当，这可能会带来新问题。如果应用程序在使用许多慢线程而不是少数快速线程时运行得更好，则在 vCPU 减少后，它可能会表现不佳。

一旦我们知道 VM 需要什么，我们就需要进行项目和推荐。我们应用与客户操作系统相同的技术。

## 来宾操作系统内存大小

来宾操作系统内存的准确性在虚拟化世界中一直是争论的焦点。看看下面的使用图。它有两个条，显示为细条和粗条。它们显示不同的阈值。

细条是所有利用率指标（例如 CPU 和内存）的通用指南。较粗的条特定于内存利用率。

![利用率](1.3.12-fig-5.jpg)

当您将资金花在基础设施上时，您希望最大限度地利用它，最好是 100%。毕竟，您需要为整个盒子付费。在内存的情况下，使用整个硬件甚至是有意义的，因为内存的真正目的只是磁盘缓存。

上面的第一条显示利用率范围 (0% - 100%)。绿色范围是您希望利用率下降的地方。低于 50% 标记以蓝色显示，象征寒冷。如果利用率低于 50%，公司就是在浪费钱。因此，位于绿色区域下方的并不是更绿色的区域；这是一个浪费区。另一方面，高于 75% 会带来 [性能](http://virtual-red-dot.info/vmware-performance-sla/) 可能受到影响的风险。因此我设置了一个黄色和红色的阈值。绿色区域实际上是一个相对 **窄的** 带。

现在让我们将上述概念应用于内存利用率。

一般来说，应用程序倾向于在任何给定时间处理其 [工作集](https://en.wikipedia.org/wiki/Working_set) 的一部分。该过程并非一直都在触及其所有内存。结果，剩下的就变成了缓存。这就是为什么活动 + 缓存超过 95% 是可以的。如果您的 ESXi 显示为 98%，请不要惊慌。事实上，ESXi 会等到它通过 99% 才会触发 [气球](/zh/metrics/chapter-3-memory-metrics/2.3.5-esxi-host/) 进程。 Windows 和 Linux 也在这样做。现代操作系统正在为您缓存所有这些页面。因此，您希望将免费页面保持在低位。

|规则 |说明 |
| --- | --- |
|包括高速缓存 |来宾操作系统使用 RAM 作为高速缓存。如果根据实际使用情况调整操作系统的大小，它将既没有缓存也没有空闲内存。它将开始分页为 Cache 和 Free 腾出空间，这可能会导致性能问题。因此，这个提议的计数器的名称不应称为需求，因为它包含的不仅仅是未满足的需求。这是操作系统在没有大量分页的情况下运行所需要的。因此，要使用的计数器的名称是 Memory Needed，而不是 Memory Demand。 |
|不包括页面文件|包含页面文件会导致大小过于保守，因为 Windows 和 Linux 甚至在它们的 In Use 计数器中都有缓存。 <br />Guest OS 使用虚拟 RAM 和物理 RAM。当由于内存映射文件没有真正的需求时，它们会主动分页和预取页。这使得无法确定未满足的需求。 Page Vault 不区分真实需求和活跃需求。 |
|不要回到VM指标|因为我们正在调整客户操作系统的大小，所以我们只使用客户操作系统。没有回退到 VM，因为它不准确。 |
|排除延迟 | RAM 争用衡量延迟，因此不适用。我们测量的是磁盘空间，而不是延迟。空间，而不是速度。利用率，而不是性能。 |

与 CPU 不同，Windows 和 Linux 在内存方面有更多不同。

对于 vRealize Operations 的特定实施，请查看 [这篇文章](https://blogs.vmware.com/management/2020/01/rightsizing-vms-with-vrealize-operations.html) by [Brandon Gordon](https://blogs.vmware.com/management/author/brandon_gordon).