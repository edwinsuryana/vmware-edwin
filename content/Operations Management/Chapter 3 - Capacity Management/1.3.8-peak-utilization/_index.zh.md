---
title: "8. 峰值利用率"
date: 2021-06-14T11:47:06+10:00
draft: false
weight: 80
---

我们从客户那里得到的一个常见要求是需要调整峰值。我们经常看到定义峰值实际是什么的错误，因为默认情况下，***平均值*** 会妨碍。

因此，让我们详细说明峰值。

您如何定义峰值利用率或争用而不会过于保守或激进？

峰有两个维度。您可以跨时间或小组成员衡量它们。

我们以一个有 8 台 ESXi 主机的集群为例。下图显示了 8 个 ESXi 利用率。

当天集群的最高利用率是多少？

此问题的问题在于一天有 1440 分钟，因此每个 ESXi 主机至少有 288 个计数器（基于 5 分钟的报告周期）。因此，该集群当天有 288 x 8 = 2304 个指标。真正的峰值必须是这 2304 个指标中最高的。

![主机利用率随时间变化](1.3.8-fig-1.png)

要获得这个真正的峰值，您需要跨组成员进行测量。对于每个样本数据，从利用率最高的主机获取利用率。在我们的集群示例中，在上午 9 点 05 分，主机 1 的利用率是所有主机中最高的。假设它达到 99%。那么我们认为上午9:05集群 ***峰值*** 的峰值利用率也是99%。

您对每个采样周期（例如，上午 9:10、上午 9:15）重复此过程。您可能会在不同时间获得不同的主机。您不会知道哪个主机提供了峰值，因为它会不时发生变化。

这个真正的高峰有什么问题？

是的，它可能太敏感了。仅需要 2304 个指标中的 1 个。如果要忽略异常值，则需要使用百分位数。例如，如果您执行第 99 个百分位数，它将删除最高的 ~23 个数据点。

请注意，最常用的方法是采用群集中所有 8 台 ESXi 主机的 _average_ 利用率。所以你失去了真正的峰值，因为每个数据点都变成了平均值。集群要达到80%的平均利用率，至少一台ESXi主机必须达到80%以上。这意味着您不能排除主机接近 100% 的可能性。

相同的逻辑适用于 VM。如果具有 64 个 vCPU 的虚拟机达到 90% 的利用率，则某些内核可能会达到 100%。这种方法会导致漏报，因为它在任何给定时刻取“成员”的平均值，然后随着时间的推移（例如，过去 24 小时）取峰值。

这种“平均问题”在监控中基本上无处不在，因为它是聚合的默认技术。更深入的阅读请查看 [这个](https://bravenewgeek.com/everything-you-know-about-latency-is-wrong/) 分析 [Tyler Treat](https://bravenewgeek.com/about-me/)。