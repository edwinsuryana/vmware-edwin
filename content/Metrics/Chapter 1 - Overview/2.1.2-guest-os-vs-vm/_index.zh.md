---
title: "2. 来宾操作系统与虚拟机"
date: 2021-06-14T15:06:50+10:00
draft: false
weight: 20
---

来宾 OS 和 VM 是两个密切相关但不同的实体。它们是 SDDC 堆栈中的相邻层。这两层是不同的，每一层都提供了另​​一层可能无法提供的独特可见性。来宾操作系统消耗的资源与底层 VM 消耗的资源不同。电源管理和 CPU SMT 等其他因素也会导致差异。

下图使用_英语_单词“需求”和“使用”来解释这个概念，其中需求包括使用和未满足的需求。这并不意味着 vSphere 和 vRealize Operations 中的需求和使用计数器，这意味着不要假设这些计数器实际上意味着这个。它们是为不同的目的而创建的。

![来宾操作系统视图和虚拟机视图](2.1.2-fig-1.png)

我尝试将应用程序添加到上图中，但是我删除了它使整个图片变得复杂。所以请注意一些应用程序，如 Java VM 和数据库管理自己的资源。另一个虚拟化层（例如 Container）无疑将复杂性提升到另一个层次。

我们可以从上面看到区域 A 对虚拟机管理程序不可见。

#### A层

来宾操作系统内部的队列（CPU 运行队列、RAM 页面文件、磁盘队列长度、驱动程序队列、网卡环形缓冲区）。这些队列对底层管理程序不可见，因为它们尚未发送到内核。例如，如果 Oracle 向 Windows 发送 IO 请求，并且 Windows 存储子系统已满，则不会将此 IO 发送到管理程序。因此，VM 级别的磁盘 IOPS 计数器将报告，因为它尚未收到此 IO 请求。

#### B层

来宾实际使用的内容。这对虚拟机管理程序是可见的，因为 VM 基本上是一个多进程应用程序。来宾操作系统 CPU 利用率以某种方式转化为 VM CPU 运行。我添加了“以某种方式”这个词，因为这两个计数器是相互独立计算的，并且可能在不同的采样时间和汇总技术下进行。

#### C层

管理程序开销（CPU 系统、CPU MKS、CPU VMX、RAM 开销、磁盘快照）。这种开销显然对来宾操作系统不可见。您可以通过安装工具获得一些可见性，因为它将向 Windows/Linux 添加新计数器。工具不会修改现有的 Windows/Linux 计数器，这意味着它们仍然不知道虚拟化。

从 VMkernel 的角度来看，VM 是在 VMkernel 中运行的一组进程或用户世界。有3种主要类型的组：

- VM Executable (VMX) 进程负责处理对性能不重要的设备的 I/O。 VMX 还负责与用户界面、快照管理器和远程控制台通信。
- VM Monitor (VMM) 进程负责虚拟化客户操作系统指令，并管理内存映射。 VMM 将存储和网络 I/O 请求传递给 VMkernel，并将所有其他请求传递给 VMX 进程。分配给 VM 的每个虚拟 CPU 都有一个 VMM。
- 鼠标键盘屏幕 (MKS) 进程负责呈现访客视频并处理访客操作系统用户输入。当您通过 vCenter 客户端控制台进入 VM 时，已完成的工作将计入此过程。这反过来又由 VM 收费，而不是特定的 vCPU。

如果您想查看上述过程中的错误示例，请查看此知识库文章 [知识库](https://kb.vmware.com/s/article/1019471).

#### D层

未满足的需求（CPU 就绪、CPU 同步停止、CPU 重叠、CPU VM 等待、RAM 争用、VM 未完成 IO）。

来宾操作系统遇到时间冻结或缓慢。它不知道它是什么，这意味着它无法解释它。

----

我已经用简单的术语介绍了差异，并没有对全部差异做出公正的判断。如果你想读一篇科学论文，我推荐这篇论文 [这篇报告](https://link.springer.com/chapter/10.1007%2F978-3-642-29737-3_26) 写的 Benjamin Serebrin 和 [Daniel Hecht](https://dblp.org/pid/73/11144.html).

由于我们在本书后面的相应章节中介绍了 CPU、内存、磁盘和网络指标，因此我们将更详细地解释它们之间的差异。现在，我们将提供一些示例来说明这一点。