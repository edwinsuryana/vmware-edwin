---
title: "1. 衡量指标的细微差别"
date: 2021-06-14T14:47:20+10:00
draft: false
weight: 10
---

![衡量指标的灵感](2.1.1-fig-1.png)

#### 相同的名称，相同的对象，不同的公式

计数器具有相同的名称，属于同一个对象，但根据您在对象中测量它的位置，它们具有不同的公式。

在 vCPU 级别使用的 VM CPU 不包括系统时间，但在 VM 级别包括。原因是系统时间不存在于 vCPU 级别，因为记帐是在 VM 级别收费的。

#### 同名不同配方

具有相同名称的计数器在不同的 vSphere 对象中并不总是具有相同的公式。

内存使用：在 VM 中，这映射到 Active，而在 ESXi Host 中，它映射到 Consumed。在集群中，这是消耗 + 开销[^1]。 vRealize Operations 使用来宾操作系统数据进行使用，如果不可用则回退到活动状态。

内存消耗：在 ESXi 中，这包括 ESXi 消耗的内存，而在集群中，它仅包括 VM 消耗的内存。

内存消耗：在 VM 中这不包括开销，而在集群中它包含。
使用的 VM 包括超线程，但惩罚为 37.5%。使用的 ESXi 也知道 HT，但惩罚是 50%。

Linux 中的 Steal Time 仅包括 CPU Ready，而 VM 中的 Stolen 时间包括许多其他因素，包括 CPU 频率。

#### 相同的名字，不同的意思

名称相同但含义不同的计数器。请小心，因为您可能会误解它们。

当 ESXi CPU 使用率 (%) 显示 100% 时，VM CPU 使用率 (%) 显示 62.5%。这是因为 VM CPU Usage 考虑了超线程，而 ESXi CPU Usage 没有。当 VM vCPU 运行的 ESXi 核心也在运行另一个线程时，就会发生这种情况。

另一个例子是延迟。磁盘延迟和内存延迟表示存在性能问题。它们实际上是衡量底层 IaaS 为 VM 服务的程度的主要计数器。但 CPU 延迟并不 ***总是*** 表示性能问题。它的值受超线程和 CPU 频率的影响，可以上升或下降。当然，VM 以更高或更低的 CPU 速度运行，或者运行效率较低，但它不会等待服务。它相当于在较旧的 CPU 上运行。

#### 相同的名字，不同的行为

从监控的角度来看，内存和 CPU 预留具有不同的行为。

VM RAM 预留是永久性的，因此会影响内存利用率。 Memory Consumed 计数器包括它，即使页面实际上还没有被消耗。如果将 16 GB RAM 的 VM 启动到 BIOS 状态，并且它有 10 GB 的内存预留，则 VM 已消耗内存计数器将跳至 10 GB。它实际上并未消耗 10 GB，但由于 ESXi 已保留该空间，因此其他 VM 无法使用该空间。

VM CPU 预留是按需进行的，因此它不会影响 CPU 利用率。 Run、Used、Demand、Usage 不包括在内。如果来宾操作系统未运行，它们的值将为 0 或接近 0。

#### 同一个目的，不同的名字

您会期望如果目的相同，则标签或名称将相同。

虚拟机中的 Swapped Memory 称为 Swapped，而在 ESXi 中称为 Swap Used。

VM 中的静态频率 CPU 利用率称为 Run，而 ESXi 称为 Utilization。

vCenter 所称的逻辑处理器（在客户端 UI 中）是 ESXi 所称的物理 CPU（在 esxtop 面板中）

#### 令人困惑的名字

柜台名称可能不清楚。

VM CPU 等待计数器包括空闲时间。由于许多 VM 未以 100% 运行，您将看到 CPU 等待计数器很高。您可能认为它正在等待某些东西（例如磁盘或内存），但它只是闲置。

在 Microsoft Windows 中，CPU 队列只计算队列大小，而磁盘队列不包括正在处理的 IO 命令。

#### 令人困惑的测量指标

为什么 VM CPU Ready 高于 100%？如果您查看 esxtop，许多 VM 级别计数器 >100%。

#### 混淆单元

为什么 CPU 计数器以毫秒表示而不是百分比或 GHz？时间计数器（在本例中为毫秒）如何计算 CPU 频率？这是有充分理由的！

#### “缺失”计数器

您会找到 VM CPU Demand，而不是 VM Memory Demand。需求不适用于内存，因为它是一种存储形式，就像笔记本电脑磁盘空间没有需求指标一样。

#### 太多选择

当您有两块显示不同时间的手表时，您不确定哪一块是正确的。

VM CPU“利用率”有五个计数器：运行、已使用、使用情况、以MHz为单位的使用情况和需求。为什么有这么多计数器只是为了跟踪利用率，与 Windows 或 Linux 跟踪的不同？

ESXi CPU“利用率”有 6 个计数器：Core Utilization、Utilization、Used、Usage、Uzure in MHz 和 Demand。

您必须记住，计数器不仅仅是为 vSphere 管理员创建的。 VMkernel 调度程序本身也将它们用作输入。 CPU 延迟就是这样一种计数器。

#### ESXi 与 vCenter

虽然 ESXi 是计数器的来源，但 vCenter 可能会添加自己的计数器，并且公式在所有情况下并不总是 100% 匹配，例如已使用与使用情况。

ESXi 为 VM CPU 提供 Run (ms)、Used (ms)、Demand (MHz)。 vCenter 增加了使用率 (MHz) 和使用率 (%)，这会造成混淆，因为现在有 5 种选择。

ESXi 显示已使用 (%)，而 vCenter 显示已使用 (ms)。第一个受 CPU 频率影响，可以超过 100%。

#### ESXi != VMs + VMkernel

ESXi 上的计数器比其 VM + VMkernel 的总和更复杂。原因是必须考虑其他参数。例如，CPU SMP（或 Intel 称之为超线程）的影响不是在 VM 级别测量的。对 VM 计数器求和时要小心，并假设它是 ESXi 计数器。

#### M:N 关系

具有多个虚拟磁盘的 VM 可以跨越多个数据存储，甚至 RDM。另一方面，数据存储通常托管许多 VM。一个 ESXi 可以挂载多个 LUN，一个 LUN 通常呈现在多个 ESXi 甚至多个集群中。从整体上看，这些多对多关系使得跨虚拟机、数据存储、ESXi 和集群的计数器不一致。他们每个人都是正确的，因为每个人都必须从自己的有利位置看。

#### Windows vs Linux

Windows CPU 队列不包括正在运行的线程，Linux 包括正在执行的线程。

----

复杂的东西，不是吗？而且我们还没有添加 AWS、Google、Azure、应用程序、网络等。

并非所有特定于 vSphere 的特性都能被并非专门为其构建的管理工具所充分理解。部分理解可能导致误解，因为对计数器的错误解释可能导致采取错误的行动。

还有一个可扩展性问题。在 vCenter 中，VM 级别有 17 个可用的 CPU 计数器，其中 12 个在 vCPU 级别也可用。此外，每个 VM 都带有 28 个内存计数器。这意味着具有 4 个 vCPU 的 VM 将有 93 个计数器 (17 + 4 x 12 + 28)。具有 1,000 个虚拟机和 4 个 vCPU 作为平均虚拟机大小的 vSphere 环境每次收集时将有 93K 计数器。如果您每分钟都这样做，您每天将收集近 1.34 亿个测量指标。由于很多客户喜欢保留至少6个月，那就是24+十亿个衡量指标！

有了如此多的衡量指标，获得的商业价值的数量就成为一个值得关注的问题。

vRealize Operations 不会重新生成 vCenter 的计数器。它首先了解 vSphere 的独特行为，然后通过合并和标准化计数器来简化它。例如，vRealize Operations 创建派生计数器（例如 KPI 和容量测量指标），然后根据需要将它们应用到 CPU、RAM、磁盘和网络。

[^1]：从技术上讲，由于虚拟化中的两级内存层次结构，将使用情况映射到 VM 的活动和 ESXi 的消耗是有意义的。在 VM 级别，我们使用 active 来显示 VM 实际消耗的内容（与性能相关）。在主机和集群级别，我们使用了“consumed”，因为它与 VM 声明的内容有关（与容量管理有关）。这种混乱导致客户购买的 RAM 超出了他们的需要。