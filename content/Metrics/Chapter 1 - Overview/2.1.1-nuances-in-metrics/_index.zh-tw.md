---
title: "1. 衡量指標的細微差別"
date: 2021-06-14T14:47:20+10:00
draft: false
weight: 10
---

![衡量指標的靈感](2.1.1-fig-1.png)

#### 相同的名稱，相同的對象，不同的公式

計數器具有相同的名稱，屬於同一個對象，但根據您在對像中測量它的位置，它們具有不同的公式。

在 vCPU 級別使用的 VM CPU 不包括系統時間，但在 VM 級別包括。原因是系統時間不存在於 vCPU 級別，因為記帳是在 VM 級別收費的。

#### 同名不同配方

具有相同名稱的計數器在不同的 vSphere 對像中並不總是具有相同的公式。

內存使用：在 VM 中，這映射到 Active，而在 ESXi Host 中，它映射到 Consumed。在集群中，這是消耗 + 開銷[^1]。 vRealize Operations 使用來賓操作系統數據進行使用，如果不可用則回退到活動狀態。

內存消耗：在 ESXi 中，這包括 ESXi 消耗的內存，而在集群中，它僅包括 VM 消耗的內存。

內存消耗：在 VM 中這不包括開銷，而在集群中它包含。
使用的 VM 包括超線程，但懲罰為 37.5%。使用的 ESXi 也知道 HT，但懲罰是 50%。

Linux 中的 Steal Time 僅包括 CPU Ready，而 VM 中的 Stolen 時間包括許多其他因素，包括 CPU 頻率。

#### 相同的名字，不同的意思

名稱相同但含義不同的計數器。請小心，因為您可能會誤解它們。

當 ESXi CPU 使用率 (%) 顯示 100% 時，VM CPU 使用率 (%) 顯示 62.5%。這是因為 VM CPU Usage 考慮了超線程，而 ESXi CPU Usage 沒有。當 VM vCPU 運行的 ESXi 核心也在運行另一個線程時，就會發生這種情況。

另一個例子是延遲。磁盤延遲和內存延遲表示存在性能問題。它們實際上是衡量底層 IaaS 為 VM 服務的程度的主要計數器。但 CPU 延遲並不 ***總是*** 表示性能問題。它的值受超線程和 CPU 頻率的影響，可以上升或下降。當然，VM 以更高或更低的 CPU 速度運行，或者運行效率較低，但它不會等待服務。它相當於在較舊的 CPU 上運行。

#### 相同的名字，不同的行為

從監控的角度來看，內存和 CPU 預留具有不同的行為。

VM RAM 預留是永久性的，因此會影響內存利用率。 Memory Consumed 計數器包括它，即使頁面實際上還沒有被消耗。如果將 16 GB RAM 的 VM 啟動到 BIOS 狀態，並且它有 10 GB 的內存預留，則 VM 已消耗內存計數器將跳至 10 GB。它實際上並未消耗 10 GB，但由於 ESXi 已保留該空間，因此其他 VM 無法使用該空間。

VM CPU 預留是按需進行的，因此它不會影響 CPU 利用率。 Run、Used、Demand、Usage 不包括在內。如果來賓操作系統未運行，它們的值將為 0 或接近 0。

#### 同一個目的，不同的名字

您會期望如果目的相同，則標籤或名稱將相同。

虛擬機中的 Swapped Memory 稱為 Swapped，而在 ESXi 中稱為 Swap Used。

VM 中的靜態頻率 CPU 利用率稱為 Run，而 ESXi 稱為 Utilization。

vCenter 所稱的邏輯處理器（在客戶端 UI 中）是 ESXi 所稱的物理 CPU（在 esxtop 面板中）

#### 令人困惑的名字

櫃檯名稱可能不清楚。

VM CPU 等待計數器包括空閒時間。由於許多 VM 未以 100% 運行，您將看到 CPU 等待計數器很高。您可能認為它正在等待某些東西（例如磁盤或內存），但它只是閒置。

在 Microsoft Windows 中，CPU 隊列只計算隊列大小，而磁盤隊列不包括正在處理的 IO 命令。

#### 令人困惑的測量指標

為什麼 VM CPU Ready 高於 100%？如果您查看 esxtop，許多 VM 級別計數器 >100%。

#### 混淆單元

為什麼 CPU 計數器以毫秒錶示而不是百分比或 GHz？時間計數器（在本例中為毫秒）如何計算 CPU 頻率？這是有充分理由的！

#### “缺失”計數器

您會找到 VM CPU Demand，而不是 VM Memory Demand。需求不適用於內存，因為它是一種存儲形式，就像筆記本電腦磁盤空間沒有需求指標一樣。

#### 太多選擇

當您有兩塊顯示不同時間的手錶時，您不確定哪一塊是正確的。

VM CPU“利用率”有五個計數器：運行、已使用、使用情況、以MHz為單位的使用情況和需求。為什麼有這麼多計數器只是為了跟踪利用率，與 Windows 或 Linux 跟踪的不同？

ESXi CPU“利用率”有 6 個計數器：Core Utilization、Utilization、Used、Usage、Uzure in MHz 和 Demand。

您必須記住，計數器不僅僅是為 vSphere 管理員創建的。 VMkernel 調度程序本身也將它們用作輸入。 CPU 延遲就是這樣一種計數器。

#### ESXi 與 vCenter

雖然 ESXi 是計數器的來源，但 vCenter 可能會添加自己的計數器，並且公式在所有情況下並不總是 100% 匹配，例如已使用與使用情況。

ESXi 為 VM CPU 提供 Run (ms)、Used (ms)、Demand (MHz)。 vCenter 增加了使用率 (MHz) 和使用率 (%)，這會造成混淆，因為現在有 5 種選擇。

ESXi 顯示已使用 (%)，而 vCenter 顯示已使用 (ms)。第一個受 CPU 頻率影響，可以超過 100%。

#### ESXi != VMs + VMkernel

ESXi 上的計數器比其 VM + VMkernel 的總和更複雜。原因是必須考慮其他參數。例如，CPU SMP（或 Intel 稱之為超線程）的影響不是在 VM 級別測量的。對 VM 計數器求和時要小心，並假設它是 ESXi 計數器。

#### M:N 關係

具有多個虛擬磁盤的 VM 可以跨越多個數據存儲，甚至 RDM。另一方面，數據存儲通常託管許多 VM。一個 ESXi 可以掛載多個 LUN，一個 LUN 通常呈現在多個 ESXi 甚至多個集群中。從整體上看，這些多對多關係使得跨虛擬機、數據存儲、ESXi 和集群的計數器不一致。他們每個人都是正確的，因為每個人都必須從自己的有利位置看。

#### Windows vs Linux

Windows CPU 隊列不包括正在運行的線程，Linux 包括正在執行的線程。

----

複雜的東西，不是嗎？而且我們還沒有添加 AWS、Google、Azure、應用程序、網絡等。

並非所有特定於 vSphere 的特性都能被並非專門為其構建的管理工具所充分理解。部分理解可能導致誤解，因為對計數器的錯誤解釋可能導致採取錯誤的行動。

還有一個可擴展性問題。在 vCenter 中，VM 級別有 17 個可用的 CPU 計數器，其中 12 個在 vCPU 級別也可用。此外，每個 VM 都帶有 28 個內存計數器。這意味著具有 4 個 vCPU 的 VM 將有 93 個計數器 (17 + 4 x 12 + 28)。具有 1,000 個虛擬機和 4 個 vCPU 作為平均虛擬機大小的 vSphere 環境每次收集時將有 93K 計數器。如果您每分鐘都這樣做，您每天將收集近 1.34 億個測量指標。由於很多客戶喜歡保留至少6個月，那就是24+十億個衡量指標！

有瞭如此多的衡量指標，獲得的商業價值的數量就成為一個值得關注的問題。

vRealize Operations 不會重新生成 vCenter 的計數器。它首先了解 vSphere 的獨特行為，然後通過合併和標準化計數器來簡化它。例如，vRealize Operations 創建派生計數器（例如 KPI 和容量測量指標），然後根據需要將它們應用到 CPU、RAM、磁盤和網絡。

[^1]：從技術上講，由於虛擬化中的兩級內存層次結構，將使用情況映射到 VM 的活動和 ESXi 的消耗是有意義的。在 VM 級別，我們使用 active 來顯示 VM 實際消耗的內容（與性能相關）。在主機和集群級別，我們使用了“consumed”，因為它與 VM 聲明的內容有關（與容量管理有關）。這種混亂導致客戶購買的 RAM 超出了他們的需要。